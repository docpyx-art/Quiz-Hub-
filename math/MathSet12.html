<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Math – Set 12</title>

<!-- MathJax -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(','\\)'], ['$', '$']],
      displayMath: [['\\[','\\]']]
    },
    options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] },
    chtml: { scale: 1.25 }
  };
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#fff; }

/* ✅ Top bar (flex) so buttons never cover title */
.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 20px;
  border-bottom:1px solid #ccc;
  font-weight:bold;
}
.top-left{ display:flex; align-items:center; gap:12px; }
.top-right{ display:flex; align-items:center; gap:10px; }
.top-title{ font-weight:bold; }

.test-btn{
  padding:6px 12px;
  font-size:14px;
  border-radius:4px;
  border:1px solid #ff6f61;
  background:#fff;
  color:#ff6f61;
  cursor:pointer;
}
.calc-btn{
  padding:6px 12px;
  font-size:14px;
  border-radius:4px;
  border:1px solid #0077cc;
  background:#fff;
  color:#0077cc;
  cursor:pointer;
}

/* Container: single column layout */
.container{
  display:flex;
  flex-direction:column;
  flex-grow:1;
  padding:20px;
  padding-bottom:150px;
}

.passage{ font-size:16px; line-height:1.6; white-space:pre-wrap; margin-bottom:20px; }
#stem{ margin-bottom:6px; }

.qbox{
  display:inline-block;
  align-self:flex-start;
  padding:4px 8px;
  width:auto;
  text-align:center;
  border:2px solid #000;
  border-radius:4px;
  font-weight:bold;
  font-size:16px;
  margin-bottom:35px;
}

.options label{ display:block; margin:10px 0; padding:6px; cursor:pointer; border-radius:4px; }
.correct{ background:#d4edda; }
.incorrect{ background:#f8d7da; }

/* ✅ Darker radio dot */
.options input[type="radio"]{
  width:20px;
  height:20px;
  transform: translateY(4px);
  accent-color:#000;
}

/* Images */
.qimg{
  max-width:400px; width:100%; height:auto;
  display:block; margin:12px auto;
}

/* SPR input */
.spr-wrap{ margin-top:10px; }
.spr-input{
  width:220px;
  max-width:100%;
  padding:8px 10px;
  font-size:16px;
  border:1px solid #333;
  border-radius:4px;
}
.spr-hint{ margin-top:8px; font-size:14px; }

/* ✅ Post-submit result bars */
.resultText{ margin-top:10px; font-size:14px; line-height:1.6; }
.resultLine{ display:inline-block; padding:4px 8px; border-radius:6px; margin:4px 0; }
.yourAns{ background:#f8d7da; color:#000; font-weight:bold; }
.correctAns{ background:#d4edda; color:#000; font-weight:bold; }

/* Bottom bar fixed */
.bottom-bar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  width:100%;
  background:#2f3e46;
  padding:10px 20px;
  position:fixed;
  bottom:0; left:0;
  box-sizing:border-box;
  color:#fff;
  gap:10px;
  z-index:20;
}

button{ padding:9px 20px; border:none; cursor:pointer; border-radius:4px; color:#fff; font-weight:bold; }
.btn-answer{ background:#3a5a98; }
.btn-nav{ background:#556d98; }

/* Question panel */
.qpanelCollapsed{
  position:fixed;
  bottom:0;
  left:50%;
  transform:translateX(-50%);
  padding:6px 12px;
  cursor:pointer;
  background:#ff6f61;
  color:#fff;
  border-radius:4px;
  font-weight:bold;
  display:flex;
  align-items:center;
  z-index:21;
  font-size:13px;
}
.qpanelExpanded{
  display:none;
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%);
  padding:10px;
  border-radius:6px;
  background:#1a1a1a;
  color:#fff;
  max-width:800px;
  overflow-y:auto;
  font-size:14px;
  text-align:center;
  z-index:20;
  max-height:300px;
}
.qgrid{ display:grid; grid-template-columns:repeat(8,1fr); gap:6px; justify-content:center; margin-top:5px; }
.qnum-box{ padding:8px; text-align:center; cursor:pointer; border-radius:4px; background:#333; color:#fff; font-weight:bold; }
.qnum-box.attempted{ background:#ff6f61; color:#fff; }
.qnum-box:hover{ opacity:0.8; }

/* locked look */
.locked{ opacity:0.65; pointer-events:none; }

/* ✅ Click-to-zoom image */
.zoomable{
  cursor: zoom-in;
  border:none;
  border-radius:0;
}

#imgModal{
  display:none;
  position:fixed;
  top:0; left:0;
  width:100vw; height:100vh;
  background:rgba(0,0,0,0.85);
  z-index:1000;
  align-items:center;
  justify-content:center;
  padding:20px;
  box-sizing:border-box;
}
#imgModal img{
  max-width:95vw;
  max-height:85vh;
  width:auto;
  height:auto;
  border-radius:8px;
  cursor: zoom-out;
}
#imgModalClose{
  position:fixed;
  top:12px; right:16px;
  color:#fff;
  font-size:28px;
  font-weight:bold;
  cursor:pointer;
  user-select:none;
}

/* Mobile */
@media (max-width: 768px){
  .passage{ font-size:15px; margin-bottom:15px; }
  #stem{ font-size:15px; margin-bottom:10px; }
  #options label{ font-size:14px; }
  .bottom-bar{ flex-direction:column; gap:8px; }
  .btn-answer,.btn-nav{ width:100%; text-align:center; }
  .qpanelCollapsed{ font-size:12px; padding:5px 10px; }
  .qpanelExpanded{ max-height:250px; font-size:13px; padding:8px; }
  .qgrid{ grid-template-columns:repeat(4,1fr); gap:4px; }
  .qnum-box{ padding:6px; font-size:12px; }
  img{ max-width:100%; height:auto; }
  .container{ padding-bottom:190px; }
}
@media only screen and (max-width: 600px){
  .bottom-bar{ flex-direction:column; align-items:stretch; gap:8px; }
  #qpanelCollapsed{ left:10px; bottom:80px; transform:none; font-size:12px; }
  #qpanelExpanded{ left:10px; bottom:120px; transform:none; max-width:calc(100% - 20px); font-size:13px; max-height:250px; }
}
</style>
</head>

<body>

<div class="top-bar">
  <div class="top-left">
    <button id="testModeBtn" class="test-btn">Test Mode: OFF</button>
  </div>

  <div class="top-title">Math – Set 12</div>

  <div class="top-right">
    <button id="openCalculator" class="calc-btn">Calculator</button>
  </div>
</div>

<div class="container">
  <div id="qnumBox" class="qbox"></div>
  <div id="passage" class="passage"></div>
  <div id="stem"></div>
  <div id="options" class="options"></div>
  <div id="resultText" class="resultText" style="display:none;"></div>
</div>

<div class="bottom-bar">
  <button id="answerBtn" class="btn-answer">Show Correct Answer</button>
  <button id="prevBtn" class="btn-nav">Previous</button>
  <button id="nextBtn" class="btn-nav">Next</button>
  <button id="reviewBtn" class="btn-nav" style="background:#28a745;">Go to Review</button>
</div>

<div id="qpanel">
  <div id="qpanelCollapsed" class="qpanelCollapsed">
    <span id="currentQuestionLabel">Question</span>
    <span id="toggleArrow" style="margin-left:6px;">▲</span>
  </div>
  <div id="qpanelExpanded" class="qpanelExpanded">
    <div id="qgrid" class="qgrid"></div>
  </div>
</div>

<!-- ✅ Image modal -->
<div id="imgModal">
  <div id="imgModalClose">✕</div>
  <img id="imgModalPic" alt="Zoomed image">
</div>

<script>
document.getElementById('openCalculator').addEventListener('click', function() {
  window.open(
    'https://www.desmos.com/testing/collegeboard/graphing',
    'CalculatorWindow',
    'width=900,height=600,top=100,left=100,resizable=yes,scrollbars=yes'
  );
});

/* typeset */
function typesetMath(){
  if(window.MathJax && MathJax.typesetPromise){
    const nodes = [
      document.getElementById('passage'),
      document.getElementById('options'),
      document.getElementById('stem'),
      document.getElementById('resultText'),
      document.getElementById('reviewPage')
    ].filter(Boolean);
    MathJax.typesetClear(nodes);
    MathJax.typesetPromise(nodes);
  }
}

// ===== numeric equivalence (SPR) =====
function toNumber(value){
  if(value==null) return null;
  let s = value.toString().trim();
  s = s.replace(/\s+/g,"");
  s = s.replace(/\u2212/g,"-");

  const frac = s.match(/^(-?\d+(\.\d+)?)\/(-?\d+(\.\d+)?)$/);
  if(frac){
    const n = parseFloat(frac[1]);
    const d = parseFloat(frac[3]);
    if(d !== 0) return n/d;
  }
  const num = parseFloat(s);
  return isNaN(num) ? null : num;
}
function numbersEqual(a,b,t=0.0001){
  if(a==null||b==null) return false;
  return Math.abs(a-b) < t;
}
function isCorrectAnswer(idx, givenRaw){
  const q = questions[idx];
  const correct = q.answer;

  const givenStr = (givenRaw ?? "").toString().trim();
  if(!givenStr) return false;

  // MCQ: exact letter match
  if(q.options) return givenStr === (correct ?? "").toString().trim();

  // SPR: numeric equivalence
  const givenNum = toNumber(givenStr);
  if(Array.isArray(correct)) return correct.some(c => numbersEqual(toNumber(c), givenNum));
  return numbersEqual(toNumber(correct), givenNum);
}

// ==== QUESTIONS (Set 12: 363–378) ====
const questions = [
  {
    num: 363,
    passage: `
      <img src="363.png" class="qimg">
      The table gives the average time \\( t \\), in minutes, it takes Carly to travel a certain distance \\( d \\), in kilometers. Which equation could represent this linear relationship?
    `,
    stem: "",
    options: { A:"\\( t = 4d \\)", B:"\\( t = \\frac{1}{25} d \\)", C:"\\( t = 25d \\)", D:"\\( t = \\frac{1}{4} d \\)" },
    answer: "C",
    img: null
  },
  {
    num: 364,
    passage: `
      <img src="364.png" class="qimg">
      The graph of the function \\( f \\), where \\( y = f(x) \\), gives the total cost \\( y \\), in dollars, for a certain video game system and \\( x \\) games. What is the best interpretation of the slope of the graph in this context?
    `,
    stem: "",
    options: { A:"Each game costs \\$25.", B:"The video game system costs \\$100.", C:"The video game system costs \\$25.", D:"Each game costs \\$100." },
    answer: "A",
    img: null
  },
  {
    num: 365,
    passage: `
      <img src="365.png" style="width: 280px;" class="qimg">
      Points \\( M \\), \\( N \\), and \\( P \\) lie on the circle shown. On this circle, minor arc \\( MN \\) has a length of 39 centimeters and major arc \\( MPN \\) has a length of 195 centimeters. What is the circumference, in centimeters, of the circle shown?
    `,
    stem: "",
    options: { A:"39", B:"156", C:"195", D:"234" },
    answer: "D",
    img: null
  },
  {
    num: 366,
    passage: `
      In triangle \\( ABC \\), the measure of angle \\( A \\) is \\( 50^\\circ \\). If triangle \\( ABC \\) is isosceles, which of the following is NOT a possible measure of angle \\( B \\)?
    `,
    stem: "",
    options: { A:"50°", B:"65°", C:"80°", D:"100°" },
    answer: "D",
    img: null
  },
  {
    num: 367,
    passage: `
      An inspector begins a day of work with a large sample of shirts that need to be checked for defects. The inspector works at a constant rate throughout the morning. What type of model is best to model the number of shirts remaining to be checked for defects at any given time throughout the morning?
    `,
    stem: "",
    options: { A:"A linear model with a positive slope", B:"A linear model with a negative slope", C:"An exponential growth model", D:"An exponential decay model" },
    answer: "B",
    img: null
  },
  {
    num: 368,
    passage: `
      <img src="368.png" style="width: 250px;" class="qimg">
      The table above shows the number of international tourist arrivals, rounded to the nearest tenth of a million, to the top nine tourist destinations in both 2012 and 2013. Based on the information given in the table, how much greater, in millions, was the median number of international tourist arrivals to the top nine tourist destinations in 2013 than the median number in 2012, to the nearest tenth of a million?
    `,
    stem: "",
    options: null,
    answer: "1.3",
    img: null
  },
  {
    num: 369,
    passage: `
      If \\( x \\ne 0 \\), which of the following expressions is equivalent to
      \\[
        \\frac{\\sqrt{16x^4y^8}}{x^3}
      \\] ?
    `,
    stem: "",
    options: { A:"\\( 8x^2y^4 \\)", B:"\\( 4xy^4 \\)", C:"\\( 4x^{-2}y^2 \\)", D:"\\( 4x^{-1}y^4 \\)" },
    answer: "D",
    img: null
  },
  {
    num: 370,
    passage: `
      \\[
        g(x) = x^2 + 55
      \\]
      What is the minimum value of the given function?
    `,
    stem: "",
    options: { A:"0", B:"55", C:"110", D:"3,025" },
    answer: "B",
    img: null
  },
  {
    num: 371,
    passage: `
      Which expression is equivalent to
      \\[
        \\frac{4}{4x - 5} - \\frac{1}{x + 1} \\, ?
      \\]
    `,
    stem: "",
    options: { A:"\\( \\frac{1}{(x+1)(4x-5)} \\)", B:"\\( \\frac{3}{3x-6} \\)", C:"\\( -\\frac{1}{(x+1)(4x-5)} \\)", D:"\\( \\frac{9}{(x+1)(4x-5)} \\)" },
    answer: "D",
    img: null
  },
  {
    num: 372,
    passage: `
      \\[
        \\frac{x^2 - c}{x - b}
      \\]
      In the expression above, \\( b \\) and \\( c \\) are positive integers. If the expression is equivalent to \\( x + b \\) and \\( x \\ne b \\), which of the following could be the value of \\( c \\)?
    `,
    stem: "",
    options: { A:"4", B:"6", C:"8", D:"10" },
    answer: "A",
    img: null
  },
  {
    num: 373,
    passage: `
      According to data provided by the US Department of Energy, the average price per gallon of regular gasoline in the United States from September 1, 2014, to December 1, 2014, is modeled by the function \\( F \\) defined below, where \\( F(x) \\) is the average price per gallon \\( x \\) months after September 1.
      \\[
        F(x) = 2.74 - 0.19(x - 3)
      \\]
      The constant 2.74 in this function estimates which of the following?
    `,
    stem: "",
    options: { A:"The average monthly decrease in the price per gallon", B:"The difference in the average price per gallon from September 1, 2014, to December 1, 2014", C:"The average price per gallon on September 1, 2014", D:"The average price per gallon on December 1, 2014" },
    answer: "D",
    img: null
  },
  {
    num: 374,
    passage: `
      In the \\( xy \\)-plane, line \\( \\ell \\) passes through the point \\( (0, 0) \\) and is parallel to the line represented by the equation \\( y = 8x + 2 \\). If line \\( \\ell \\) also passes through the point \\( (3, d) \\), what is the value of \\( d \\)?
    `,
    stem: "",
    options: null,
    answer: "24",
    img: null
  },
  {
    num: 375,
    passage: `
      A line intersects two parallel lines, forming four acute angles and four obtuse angles. The measure of one of these eight angles is \\( (7x - 250)^\\circ \\). The sum of the measures of four of the eight angles is \\( k^\\circ \\). Which of the following could NOT be equivalent to \\( k \\), for all values of \\( x \\)?
    `,
    stem: "",
    options: { A:"\\( -14x + 1,540 \\)", B:"\\( 14x - 320 \\)", C:"\\( -28x + 1,720 \\)", D:"360" },
    answer: "A",
    img: null
  },
  {
    num: 376,
    passage: `
      <img src="376.png" style="width: 400px;" class="qimg">
      In the figure above, \\( RT = TU \\). What is the value of \\( x \\)?
    `,
    stem: "",
    options: { A:"72", B:"66", C:"64", D:"58" },
    answer: "C",
    img: null
  },
  {
    num: 377,
    passage: `
      The mean amount of time that the 20 employees of a construction company have worked for the company is 6.7 years. After one of the employees leaves the company, the mean amount of time that the remaining employees have worked for the company is reduced to 6.25 years. How many years did the employee who left the company work for the company?
    `,
    stem: "",
    options: { A:"0.45", B:"2.30", C:"9.00", D:"15.25" },
    answer: "D",
    img: null
  },
  {
    num: 378,
    passage: `
      The scatterplot shows the relationship between the length of time \\( y \\), in hours, a certain bird spent in flight and the number of days after January 11, \\( x \\).
      <img src="378.png" style="width: 350px; height: auto; margin: 12px 0;" class="qimg">
      What is the average rate of change, in hours per day, of the length of time the bird spent in flight on January 13 to the length of time the bird spent in flight on January 15?
    `,
    stem: "",
    options: null,
    answer: ["4.5", "9/2"],
    img: null
  }
];

// ==== STATE ====
let currentQ = 0;
let answerShown = false;
let attempted = Array(questions.length).fill(false);
let userAnswers = Array(questions.length).fill(null);

/* Test mode state */
let isTestMode = false;
let isSubmitted = false;

function isAttemptLocked(){ return isTestMode && isSubmitted; }

function updateModeUI(){
  const answerBtn = document.getElementById('answerBtn');
  const reviewBtn  = document.getElementById('reviewBtn');

  if(isTestMode && !isSubmitted){
    answerBtn.style.display = 'none';
    reviewBtn.innerText = 'Final Submit';
  } else {
    answerBtn.style.display = 'inline-block';
    reviewBtn.innerText = 'Go to Review';
  }
}

function renderResultText(){
  const box = document.getElementById('resultText');
  if(!(isTestMode && isSubmitted)){
    box.style.display='none';
    box.innerHTML='';
    return;
  }
  const q = questions[currentQ];
  const your = (userAnswers[currentQ] ?? '').toString().trim() || '-';
  const correct = Array.isArray(q.answer) ? q.answer.join(" or ") : q.answer;

  box.style.display='block';
  box.innerHTML = `
    <div class="resultLine yourAns">Your answer: ${your}</div><br>
    <div class="resultLine correctAns">Correct answer: ${correct}</div>
  `;
  typesetMath();
}

/* ✅ image zoom (any image inside #passage) */
function hookImageZoom(){
  const imgs = document.querySelectorAll('#passage img');
  if(!imgs.length) return;

  imgs.forEach(img=>{
    img.classList.add('zoomable');
    img.addEventListener('click', ()=>{
      const modal = document.getElementById('imgModal');
      const pic   = document.getElementById('imgModalPic');
      pic.src = img.src;
      modal.style.display = 'flex';
    });
  });
}

function closeImgModal(){
  const modal = document.getElementById('imgModal');
  const pic   = document.getElementById('imgModalPic');
  modal.style.display = 'none';
  pic.src = '';
}
document.getElementById('imgModalClose').addEventListener('click', closeImgModal);
document.getElementById('imgModal').addEventListener('click', (e)=>{
  if(e.target.id === 'imgModal' || e.target.id === 'imgModalPic') closeImgModal();
});
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeImgModal(); });

function loadQuestion(){
  const q = questions[currentQ];

  // passage + optional external image field (kept for compatibility)
  if(q.img){
    document.getElementById('passage').innerHTML = `
      <img src="${q.img}" alt="Graph"
           style="max-width:520px; width:100%; height:auto; display:block; margin-bottom:12px;">
      ${q.passage}
    `;
  } else {
    document.getElementById('passage').innerHTML = q.passage;
  }

  document.getElementById('qnumBox').innerText = `Q${q.num}`;
  document.getElementById('stem').innerText = q.stem || "";

  const optionsDiv = document.getElementById('options');
  optionsDiv.innerHTML = '';

  // MCQ
  if(q.options){
    for(const [key,val] of Object.entries(q.options)){
      const lbl = document.createElement('label');
      lbl.innerHTML = `<input type="radio" name="option" value="${key}"> ${key}. ${val}`;
      const input = lbl.querySelector('input');

      if(userAnswers[currentQ] === key) input.checked = true;

      input.addEventListener('change', ()=>{
        if(isAttemptLocked()) return;
        userAnswers[currentQ] = key;
        attempted[currentQ] = true;
        updateQpanel();
        renderResultText();
      });

      if(isAttemptLocked()){
        input.disabled = true;
        lbl.classList.add('locked');
      }

      optionsDiv.appendChild(lbl);
    }
  } else {
    // SPR
    const wrap = document.createElement('div');
    wrap.className = 'spr-wrap';
    wrap.innerHTML = `
      <input id="sprInput" class="spr-input" type="text" inputmode="decimal" />
      <div id="sprAnswerReveal" class="spr-hint"></div>
    `;
    optionsDiv.appendChild(wrap);

    const sprInput = document.getElementById('sprInput');
    if(userAnswers[currentQ] !== null) sprInput.value = userAnswers[currentQ];

    sprInput.addEventListener('input', ()=>{
      if(isAttemptLocked()) return;
      userAnswers[currentQ] = sprInput.value.trim();
      attempted[currentQ] = userAnswers[currentQ].length > 0;
      updateQpanel();
      renderResultText();
    });

    if(isAttemptLocked()){
      sprInput.disabled = true;
      wrap.classList.add('locked');
    }
  }

  answerShown = false;
  document.getElementById('answerBtn').innerText = 'Show Correct Answer';

  updateQpanel();
  updateModeUI();
  renderResultText();

  typesetMath();
  hookImageZoom();
}

function toggleAnswer(){
  if(isTestMode && !isSubmitted) return;

  const q = questions[currentQ];
  const optionsDiv = document.getElementById('options');

  if(!answerShown){
    if(q.options){
      for(const input of optionsDiv.querySelectorAll('input[type="radio"]')){
        input.parentNode.classList.remove('correct','incorrect');
        if(input.value === q.answer) input.parentNode.classList.add('correct');
        else input.parentNode.classList.add('incorrect');
      }
    } else {
      const reveal = document.getElementById('sprAnswerReveal');
      if(reveal){
        const ans = Array.isArray(q.answer) ? q.answer.join(" or ") : q.answer;
        reveal.innerHTML = `<strong>Correct Answer:</strong> ${ans}`;
      }
    }
    document.getElementById('answerBtn').innerText = 'Hide Correct Answer';
    answerShown = true;
  } else {
    if(q.options){
      for(const input of optionsDiv.querySelectorAll('input[type="radio"]')){
        input.parentNode.classList.remove('correct','incorrect');
      }
    } else {
      const reveal = document.getElementById('sprAnswerReveal');
      if(reveal) reveal.innerHTML = '';
    }
    document.getElementById('answerBtn').innerText = 'Show Correct Answer';
    answerShown = false;
  }
}

document.getElementById('answerBtn').addEventListener('click', toggleAnswer);
document.getElementById('prevBtn').addEventListener('click', ()=>{ if(currentQ>0) currentQ--; loadQuestion(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ if(currentQ<questions.length-1) currentQ++; loadQuestion(); });

const collapsed = document.getElementById('qpanelCollapsed');
const expanded  = document.getElementById('qpanelExpanded');
collapsed.addEventListener('click', ()=>{ expanded.style.display = (expanded.style.display==='block')?'none':'block'; });

function updateQpanel(){
  const grid = document.getElementById('qgrid');
  grid.innerHTML = '';
  questions.forEach((q,i)=>{
    const b = document.createElement('div');
    b.innerText = q.num;
    b.className = 'qnum-box';
    b.classList.toggle('attempted', attempted[i]);
    b.addEventListener('click', ()=>{ currentQ=i; loadQuestion(); expanded.style.display='none'; });
    grid.appendChild(b);
  });
  document.getElementById('currentQuestionLabel').innerText =
    `Question ${questions[currentQ].num} of ${questions.length}`;
}

function openReviewPage(){
  const mainContent = document.querySelector('.container');
  const bottomBar   = document.querySelector('.bottom-bar');
  const qpanel      = document.getElementById('qpanel');

  mainContent.style.display = 'none';
  bottomBar.style.display   = 'none';
  qpanel.style.display      = 'none';

  let reviewDiv = document.getElementById('reviewPage');
  if(!reviewDiv){
    reviewDiv = document.createElement('div');
    reviewDiv.id = 'reviewPage';
    reviewDiv.style.padding = '20px';
    reviewDiv.style.maxWidth = '700px';
    reviewDiv.style.margin = '0 auto';
    document.body.appendChild(reviewDiv);
  }
  reviewDiv.style.display = 'block';
  reviewDiv.innerHTML = '<h2>Review Questions</h2>';

  const correctCount = userAnswers.filter((ans, idx)=> isCorrectAnswer(idx, ans)).length;
  const totalCount = questions.length;

  const scoreDiv = document.createElement('div');
  scoreDiv.style.fontWeight = 'bold';
  scoreDiv.style.marginBottom = '8px';
  scoreDiv.innerText = `Score: ${correctCount} / ${totalCount}`;
  reviewDiv.appendChild(scoreDiv);

  const legend = document.createElement('div');
  legend.style.fontSize='14px';
  legend.style.marginBottom='12px';
  legend.style.color='#333';
  legend.innerText = 'Green = correct, Red = incorrect, Grey = unanswered';
  reviewDiv.appendChild(legend);

  const ul = document.createElement('ul');
  ul.style.listStyle='none';
  ul.style.padding='0';
  ul.style.display='flex';
  ul.style.flexWrap='wrap';
  ul.style.gap='8px';

  questions.forEach((q,i)=>{
    const li = document.createElement('li');
    li.innerText = q.num;
    li.style.padding='8px 12px';
    li.style.border='1px solid #333';
    li.style.borderRadius='4px';
    li.style.cursor='pointer';
    li.style.color='#fff';

    const given = (userAnswers[i] ?? "").toString().trim();
    if(!given) li.style.background = '#555';
    else if(isCorrectAnswer(i, given)) li.style.background = '#28a745';
    else li.style.background = '#dc3545';

    li.addEventListener('click', ()=>{
      currentQ = i;
      loadQuestion();
      reviewDiv.style.display='none';
      mainContent.style.display='flex';
      bottomBar.style.display='flex';
      qpanel.style.display='block';
    });

    ul.appendChild(li);
  });

  reviewDiv.appendChild(ul);

  let backBtn = document.getElementById('backToTestBtn');
  if(!backBtn){
    backBtn = document.createElement('button');
    backBtn.id = 'backToTestBtn';
    backBtn.innerText = 'Back to Test';
    backBtn.style.background='#556d98';
    backBtn.style.color='#fff';
    backBtn.style.border='none';
    backBtn.style.padding='10px 20px';
    backBtn.style.marginTop='20px';
    backBtn.style.borderRadius='4px';
    backBtn.style.cursor='pointer';
    reviewDiv.appendChild(backBtn);
  }

  backBtn.onclick = ()=>{
    reviewDiv.style.display='none';
    mainContent.style.display='flex';
    bottomBar.style.display='flex';
    qpanel.style.display='block';
    loadQuestion(); // re-apply lock + result bars
  };

  typesetMath();
}

document.getElementById('reviewBtn').addEventListener('click', ()=>{
  if(isTestMode && !isSubmitted){
    const ok = confirm("Final Submit?\nAfter submission, answers will be locked.");
    if(ok){
      isSubmitted = true;
      updateModeUI();
      openReviewPage();
    }
    return;
  }
  openReviewPage();
});

document.getElementById('testModeBtn').addEventListener('click', ()=>{
  if(!isTestMode){
    isTestMode = true;
    isSubmitted = false;

    attempted = Array(questions.length).fill(false);
    userAnswers = Array(questions.length).fill(null);
    currentQ = 0;
    answerShown = false;

    document.getElementById('testModeBtn').innerText = 'Test Mode: ON';
    alert("Test Mode is ON.\n- Correct answers hidden until Final Submit.\n- Review allowed only after Final Submit.\n- Fresh attempt started.");
    updateModeUI();
    loadQuestion();
    return;
  }

  // if already submitted, allow restart test without turning off
  if(isSubmitted){
    const ok = confirm("Start a new test attempt? This will clear all your answers.");
    if(ok){
      isSubmitted = false;
      attempted = Array(questions.length).fill(false);
      userAnswers = Array(questions.length).fill(null);
      currentQ = 0;
      answerShown = false;

      const reviewDiv = document.getElementById('reviewPage');
      if(reviewDiv) reviewDiv.style.display = 'none';
      document.querySelector('.container').style.display='flex';
      document.querySelector('.bottom-bar').style.display='flex';
      document.getElementById('qpanel').style.display='block';

      updateModeUI();
      loadQuestion();
    }
    return;
  }

  // turn OFF test mode (practice)
  isTestMode = false;
  isSubmitted = false;
  document.getElementById('testModeBtn').innerText = 'Test Mode: OFF';

  const reviewDiv = document.getElementById('reviewPage');
  if(reviewDiv) reviewDiv.style.display = 'none';
  document.querySelector('.container').style.display='flex';
  document.querySelector('.bottom-bar').style.display='flex';
  document.getElementById('qpanel').style.display='block';

  updateModeUI();
  loadQuestion();
  alert("Test Mode is OFF.\nPractice Mode enabled.");
});

// init
loadQuestion();
updateModeUI();
</script>

</body>
</html>
